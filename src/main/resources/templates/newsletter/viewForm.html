<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>상세보기</title>
<style>
    body {
        font-family: 'Pretendard-Regular', sans-serif;
        color: #333;
        margin: 0;
        padding: 0;
    }
    .content {
        width: 60%;
        max-width: 950px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .view-title {
        font-size: 50px;
        text-align: center;
        margin-top: -10px;
        margin-bottom: -10px;
        font-family: 'Italianno', cursive;
        color: rgb(119, 86, 45);
    }
    .separator {
        font-size: 40px;
        color: #333;
        margin-left: 10px;
        margin-right: 10px;
    }
    .header-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
    }
    .header-title .title {
        font-size: 30px;
    }
    .header-title .actions {
        margin-bottom: -30px;
    }
    .header-title .actions span {
        margin-left: 10px;
        cursor: pointer;
        font-size: 14px;
    }
    .title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #000;
    }
    .title-row .title {
        font-size: 24px;
    }
    .title-row .date {
        font-size: 14px;
    }
    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #000;
    }
    .info-row .author {
        font-size: 14px;
    }
    .info-row .stats {
        font-size: 14px;
    }
    .content-box {
        margin-top: 20px;
        min-height: 300px;
        font-size: 14px;
    }
    .like-wrap {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
    }
    .like-wrap span {
        cursor: pointer;
        font-size: 36px;
    }
    .favorite {
        color: var(--point1);
    }
    .notFavorite {
        color: #ccc;
    }
    .file-list {
        margin-top: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #000;
    }
    .file-list a {
        display: block;
        margin: 5px 0;
        font-size: 14px;
    }
</style>
</head>
<body>
    <th:block th:include="common/header"></th:block>
    <main class="content">
        <div class="header-title">
            <div class="view-title">
                News Letter
                <span class="separator">|</span>
            </div>
            <div class="actions">
                <span th:if="${session.member != null && session.member.memberNo == newsletter.memberNo}" th:onclick="|location.href='/newsletter/editForm?boardNo=${newsletter.boardNo}'|">수정</span>
                <span th:if="${session.member != null && session.member.memberNo == newsletter.memberNo}" th:onclick="|deleteNewsletter(${newsletter.boardNo})|">삭제</span>
            </div>
        </div>
        <div class="title-row">
            <div class="title" th:text="${newsletter.boardTitle}">운동 안 하고도 살 빠지는 방법이 출시</div>
            <div class="date" th:text="${newsletter.regDate}">2024-08-01</div>
        </div>
        <div class="info-row">
            <div class="author" th:text="${newsletter.boardWriter}">관리자</div>
            <div class="stats">
                조회수: <span th:text="${newsletter.readCount}">10000</span> | 
                추천수: <span th:text="${newsletter.likeCount}">10</span> | 
                댓글: <span th:text="${newsletter.commentCount}">100</span>
            </div>
        </div>
        <div class="content-box" th:utext="${newsletter.boardContent}">
            <img src="example-image.png" alt="example" style="width:100%; height:auto;">
            <p>응, 그런 거 없어요~ 열심히 해</p>
        </div>
        <div class="like-wrap">
            <span th:if="${newsletter.isLike}==1" class="material-icons favorite">thumb_down</span>
            <span th:if="${newsletter.isLike}==0" class="material-icons notFavorite">thumb_up</span>
        </div>
        <div class="file-list">
            <div>첨부파일</div>
            <th:block th:each="file : ${newsletter.fileList}">
                <a th:href="@{/newsletter/filedown(filename=${file.filename},filepath=${file.filepath})}">
                    <span class="material-icons">description</span>
                    <span th:text="${file.filename}">파일명</span>
                </a>
            </th:block>
        </div>
        <form action="/newsletter/insertNewsLetterComment" method="post">
				<div th:if="${session.member} != null" class="input-item1 input-comment-box">
					<span class="material-icons">person</span>
					<span th:text=${session.member.memberId}></span>
					<textarea name="newsletterCommentContent" style="resize:none;"></textarea>
					<button type="submit" class="btn-square" style="height:50px">댓글작성</button>
					<input type="hidden" name="boardRef" th:value="${newsletter.boardNo}">
				</div>
			</form>
		<span>댓글수 : <span th:text="${newsletter.commentCount}"></span></span>
		<div class="comment-wrap">
			<ul th:each="newsletterComment : ${newsletter.boardCommentList}">
				<li>
					<p class="comment-info">
						<span class="material-icons">person</span>
						<span th:text="${newsletterComment.boardCommentWriter}"></span>
						작성일 : <span th:text="${newsletterComment.boardCommentDate}"></span>
						좋아요수 : <span th:text="${newsletterComment.likeCount}"></span>
						<span th:if="${newsletterComment.isLike}==1" class="material-icons favorite" th:onclick="likePush(this,[[${newsletterComment.boardCommentNo}]]);">thumb_down</span>
						<span th:if="${newsletterComment.isLike}==0" class="material-icons notFavorite" th:onclick="likePush(this,[[${newsletterComment.boardCommentNo}]]);">thumb_up</span>
						<a th:if="${session.member != null && session.member.memberNo == newsletterComment.memberNo}" href="javascript:void(0)" class="updateComment">수정</a>
						<a th:if="${session.member != null && session.member.memberNo == newsletterComment.memberNo}" href="javascript:void(0)" class="deleteComment">삭제</a>
					</p>
					<p th:text="${newsletterComment.boardCommentContent}"></p>
					<div class="reComment-box">
						<span th:text="'답글수 ' +${newsletterComment.reCommentCount}"></span>
						<div>
							<a th:if="${newsletterComment.reCommentCount > 0}" href="javascript:void(0)" th:onclick="commentShow(this,[[${newsletterComment.boardCommentNo}]]);">답글보기</a>
							<a href="javascript:void(0)" class="recShow">답글달기</a>
						</div>
					</div>
				</li>
				<li>
					<form action="/newsletter/insertNewsLetterComment" method="post">
						<div th:if="${session.member} != null" class="input-item1 input-comment-box" style="display:none;">
							<span class="material-icons">person</span>
							<span th:text=${session.member.memberId}></span>
							<textarea name="newsletterCommentContent" style="resize:none;"></textarea>
							<button type="submit" class="btn-square" style="height:50px">댓글작성</button>
							<input type="hidden" name="boardRef" th:value="${newsletter.boardNo}">
							<input type="hidden" name="boardCommentRef" th:value="${newsletterComment.boardCommentNo}">
						</div>
					</form>
				</li>
			</ul>
		</div>
    </main>
    <script>
    const boardNo = "[[${newsletter.boardNo}]]";
	$(".like-wrap>.favorite,.notFavorite").on("click",function(){
		const likeSpan = $(this);
		const isLike = likeSpan.hasClass("favorite")?1:0;
		$.ajax({
			url : "/newsletter/newsletterLikePush",
			data : {boardNo : boardNo, isLike : isLike},
			type : "post",
			success : function(data){
				if(data == -1){
					console.log("처리오류");
				}else if(data == -10){
					alert("로그인해야 이용가능합니");							
				}else{
					if(isLike === 1){
						likeSpan.removeClass("favorite");		
						likeSpan.addClass("notFavorite");
						likeSpan.text("thumb_up");
					}else{
						likeSpan.removeClass("notFavorite");
						likeSpan.addClass("favorite");
						likeSpan.text("thumb_down");
					}
					$(".view-tbl tr>td>span").eq(1).text(data);
					likeSpan.prev().text(data);
				}
			},
			error : function(){
				console.log("error");
			}
		});
	});
	function likePush(obj, newsletterCommentNo){
		const likeSpan = $(obj);
		const isLike = likeSpan.hasClass("favorite")?1:0;
		$.ajax({
			url : "/newletter/newsletterCommentLikePush",
			data : {boardCommentNo : boardCommentNo, isLike : isLike},
			type : "post",
			success : function(data){
				if(data == -1){
					console.log("처리오류");
				}else if(data == -10){
					alert("로그인해라");							
				}else{
					if(isLike === 1){
						likeSpan.removeClass("favorite");		
						likeSpan.addClass("notFavorite");
						likeSpan.text("thumb_up");
					}else{
						likeSpan.removeClass("notFavorite");
						likeSpan.addClass("favorite");
						likeSpan.text("thumb_down");
					}
					$(obj).prev().text(data);
				}
			},
			error : function(){
				console.log("error");
			}
		});
	};
	$(".recShow").on("click",function(){
		const index = $(".recShow").index(this);
		if($(this).text() === "답글달기"){
			$(this).text("취소");
		}else{
			$(this).text("답글달기");
		}
		$(".input-comment-box").eq(index+1).toggle();
	});
	function commentShow(obj, boardCommentNo){
		$.ajax({
			url : "/newsletter/newsletterreCommentList",
			data : {boardCommentNo : boardCommentNo},
			type : "post",
			success : function(data){
				for(let i=0;i<data.length;i++){
					const bc = data[i];
					const ul = $("<ul>");
					const li1 = $("<li>");
					const commentInfoP = $("<p class='comment-info'>");
					const IconSpan = $("<span class='material-icons'>");
					IconSpan.text("person");
				}
			},
			error : function(){
				console.log("error");	
			}
		});
	}
	
	function deleteNewsletter(boardNo) {
        if (confirm('정말 삭제하시겠습니까?')) {
            fetch(`/newsletter/delete?boardNo=${boardNo}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('게시물이 삭제되었습니다.');
                    window.location.href = '/newsletter/list?reqPage=1';
                } else {
                    alert('게시물 삭제에 실패하였습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }
    </script>
    <th:block th:include="common/footer"></th:block>
</body>
</html>
