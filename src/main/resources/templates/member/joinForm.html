<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>회원가입 양식</title>
<link href="/css/memberJoinForm.css" rel="stylesheet">
</head>
<body>
<th:block th:include="common/header"></th:block>
<th:block th:if="${session.member == null}">
<main class="content">
    <section class="joinform-wrap">
        <div class="page-title">
        	<p>회원가입<p>
        </div>
        
        <!-- 회원가입 양식 -->
        <form action="/member/insertMember" method="post" class="joinform-tbl">
            <table class="joinform-tbl">
                <tr>
                    <th style="width: 100px;">아이디</th>
                    <td class="input-item1">
                        <input type="text" name="memberId" id="memberId" style="width: 360px;" required>
                    </td>
                    <td>
                        <button type="button" class="btn-round" id="id-check-btn">중복 확인</button>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg-id" style="visibility: hidden">아이디 확인</p>                	
                	</td>
                </tr>
                <tr>
                    <th>비밀번호</th>
                    <td class="input-item1" colspan="2">
                        <input type="password" name="memberPw" id="memberPw" required>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg-pw" style="visibility: hidden">비밀번호 확인</p>
                	</td>
                </tr>
                <tr>
                    <th>비밀번호 확인</th>
                    <td class="input-item1" colspan="2">
                        <input type="password" name="memberPwRe" id="memberPwRe" required>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg-pwre" style="visibility: hidden">비밀번호 일치 확인</p>
                	</td>
                </tr>
                <tr>
                    <th>이름</th>
                    <td class="input-item1" colspan="2">
                        <input type="text" name="memberName" id="memberName" required>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg" style="visibility: hidden">확인</p>
                	</td>
                </tr>
                <tr>
                    <th>이메일</th>
                    <td class="input-item1" id="email-box">
                    	<input type="hidden" name="memberEmail" id="memberEmail">
                        <input type="text" name="emailInput" id="emailInput" class="email-input" required>
                        <span>@</span>
                        <input type="text" name="emailDomain" id="emailDomain" class="email-input" required readonly>
                        <select id="selectDomain" class="select email-input" >                             
                        	<option disabled selected>도메인 선택</option>
                        	<option value="naver.com">naver.com</option>
                        	<option value="gmail.com">gmail.com</option>
                        </select>
                    </td>
                    <td>
                        <button type="button" class="btn-round g" id="email-check-btn">인증코드 받기</button>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg" style="visibility: hidden">확인</p>
                	</td>
                </tr>
                <tr>
                    <th>인증 코드</th>
                    <td class="input-item1">
                        <input type="text" name="memberVeriCode" id="memberVeriCode" style="width: 360px" required>
                    </td>
                    <td>
                        <button type="button" class="btn-round g" id="code-check-btn">인증하기</button>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg" style="visibility: hidden">확인</p>
                	</td>
                </tr>
                <tr>
                    <th>전화번호</th>
                    <td class="input-item1" colspan="2">
                        <input type="text" name="memberPhone" id="memberPhone" required>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg-phone" style="visibility: hidden">전화번호 확인</p>
                	</td>
                </tr>
                <tr>
                    <th>주소</th>
                    <td class="input-item1" colspan="2">
                        <input type="text" name="memberAddr" id="memberAddr" required>
                    </td>
                </tr>
                <tr>
                	<td></td>
                	<td colspan="2">
                        <p class="check-msg" style="visibility: hidden">확인</p>
                	</td>
                </tr>
                <tr>
                    <th>생년월일</th>
                    <td class="input-item1" colspan="2">
                    	<input type="date" id="memberBirth" name="memberBirth" min="1924-01-01" max="2024-12-31">
                    </td>
                </tr>
                <tr>
                    <td colspan="3" id="submit-btn-wrap">
                        <button type="submit" class="btn-round" id="join-btn" onclick="return checkValid()">가입하기</button>
                    </td>
                </tr>
              </table>
          </form>
	</section>
</main>
<script>

	// 아이디 정규 표현식 확인
	let idRegChecked = false;
	$("#memberId").on("keyup", function(){
		$(this).removeClass("valid");
		const memberIdVal = $(this).val();
		const idReg = /^[a-zA-Z0-9]{4,20}$/;
		if(idReg.test(memberIdVal)){
			$(".check-msg-id").css("visibility", "hidden");
			idRegChecked = true;
		}
		else {
			$(".check-msg-id").text("아이디는 영문자와 숫자를 4~20글자로 조합해야 합니다.").css("visibility", "visible").css("color", "var(--point1)");
		}
	})
	
	// 아이디 중복 확인
	$("#id-check-btn").on("click", function(){
		if (idRegChecked) {
			$(".check-msg-id").css("visibility", "hidden");
			$.ajax({
				url:"/member/checkId",
				type:"get",
				data:{"checkId" : $("#memberId").val()},
				success: function(result){
					if(result > 0){ 
						$(".check-msg-id").text("이미 사용 중인 아이디입니다.").css("visibility", "visible").css("color", "var(--point1)");
					}
					else {
						$(".check-msg-id").text("사용 가능한 아이디입니다.").css("visibility", "visible").css("color", "var(--point2)");					
						$("#memberId").addClass("valid");
					}
				},
				error: function(){
					alert("서버 오류입니다. 관리자에게 문의하세요.")
				}
			})
		}
		else {
			alert("아이디가 올바르지 않습니다.")	
		}
	})
	
	// 비밀번호 정규 표현식 확인
	$("#memberPw").on("keyup", function(){
		$(this).removeClass("valid");
		const memberPwVal = $(this).val();
		const pwReg = /^[a-zA-Z0-9]{8,20}$/;
		if(pwReg.test(memberPwVal)){
			$(".check-msg-pw").css("visibility", "hidden");
			$(this).addClass("valid");
		}
		else {
			$(".check-msg-pw").text("비밀번호는 영문자와 숫자를 8~20글자로 조합해야 합니다.").css("visibility", "visible").css("color", "var(--point1)");
		}
	})
		
	// 비밀번호 일치 여부 확인 (비밀번호, 비밀번호 확인에 입력될 때마다 실행)
	function pwCheck(){
		$("#memberPwRe").removeClass("valid");
		const pwValue = $("#memberPw").val();
		const pwReValue = $("#memberPwRe").val();
		if(pwValue === pwReValue){
			$(".check-msg-pwre").css("visibility", "hidden");
			$("#memberPwRe").addClass("valid");
		} else {
			$(".check-msg-pwre").text("비밀번호가 일치하지 않습니다.").css("visibility", "visible").css("color", "var(--point1)");
		}
	}		
	$("#memberPw").on("keyup", function() {
		pwCheck();
	})
	$("#memberPwRe").on("keyup", function(){
		pwCheck();
	})
	
	// 이메일
	let veriCode = 0; // 인증 코드 용 변수

	$("#emailInput").on("keyup", function(){
		$("#memberEmail").removeClass("valid");			
		veriCode = 0;
	})
	$("#selectDomain").on("click", function(){
		$("#memberEmail").removeClass("valid");
		$("#emailDomain").val($(this).val());
		veriCode = 0;
	})

	
	// 이메일 인증
	$("#email-check-btn").on("click", function(){
		const emailInput = $("#emailInput").val();
		const emailDomain = $("#emailDomain").val();
		if(emailInput && emailDomain){
			$("#memberEmail").val(emailInput + "@" + emailDomain);
			const memberEmail = $("#memberEmail").val();
			// 인증코드 전송
			$.ajax({
				url: "/member/verifyEmail",
				type: "post",
				data: {memberEmail : memberEmail},
				success: function(result){
					// 인증 코드 발송 성공 시 result는 인증 코드 값
					if (result > 0) {
						veriCode = result;
						alert("입력하신 이메일로 인증 코드가 전송되었습니다.")
					}
					// 해당 회원 이미 있을 때
					else if (result == 0) {
						alert("이미 회원가입된 이메일입니다.")
					}
					// 에러 났을 때
					else {
						alert("처리 중 에러가 발생했습니다.")
					}
				},
				error: function(){
					alert("서버 오류입니다.");
				}
			}) // ajax 끝
		}
		else {
			alert("이메일 주소가 올바르지 않습니다.")
		}
	})
	
	// 인증 코드 일치 확인
	$("#code-check-btn").on("click", function(){
		const inputCode = $("#memberVeriCode").val();
		if (veriCode == inputCode) {
			$("#memberEmail").addClass("valid");
			alert("이메일이 인증되었습니다.");
		}
		else {
			alert("인증 코드가 올바르지 않습니다.");
		}
	})
	
	// 전화번호
	$("#memberPhone").on("change", function(){
		$("#memberPhone").removeClass("valid");
		const phoneVal = $(this).val()
		const phoneReg = /^[0-9]{11,11}$/;
		if(phoneReg.test(phoneVal) && phoneVal.length == 11){				
			$(".check-msg-phone").css("visibility", "hidden");
			$("#memberPhone").addClass("valid");
		}
		else {
			$(".check-msg-phone").text("전화번호는 11자리 숫자로 입력해야 합니다.").css("visibility", "visible").css("color", "var(--point1)");			
		}
	})
	
	// 입력값 확인
	function checkValid(){
		const valid = $(".valid");
		if(valid.length != 5){ // 아이디, 비번, 비번 확인, 이메일, 전화번호, 주소
			alert("모든 항목이 올바르게 입력되었는지 확인해 주세요.")
			return false;
		}
		return true;
	}
</script>
<th:block th:include="common/footer"></th:block>
</body>
</html>